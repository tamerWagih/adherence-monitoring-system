# Adherence Monitoring System - Docker Compose
# Backend (NestJS) + Frontend (Next.js) + NGINX
# Hosted on single VM

services:
  # Backend Service (NestJS - Adherence Backend)
  backend:
    build:
      context: ./backend
      dockerfile: ../Dockerfile.backend
    container_name: adherence-backend
    ports:
      - '4001:4001'
    env_file:
      - .env
    environment:
      - NODE_ENV=${NODE_ENV:-staging}
      - PORT=${BACKEND_PORT:-4001}
      - DATABASE_HOST=${DATABASE_HOST}
      - DATABASE_PORT=${DATABASE_PORT:-5432}
      - DATABASE_NAME=${DATABASE_NAME}
      - DATABASE_USERNAME=${DATABASE_USERNAME}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_URL=${REDIS_URL}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-24h}
      - CORS_ORIGIN=${CORS_ORIGIN}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    depends_on:
      - redis
    networks:
      - adherence-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4001/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Frontend Service (Next.js - Admin Frontend)
  frontend:
    build:
      context: ./frontend
      dockerfile: ../Dockerfile.frontend
    container_name: adherence-frontend
    ports:
      - '3001:3001'
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - NEXT_PUBLIC_APP_NAME=${NEXT_PUBLIC_APP_NAME:-Adherence Monitoring System}
      - NEXT_PUBLIC_APP_VERSION=${NEXT_PUBLIC_APP_VERSION:-1.0.0}
    depends_on:
      - backend
    networks:
      - adherence-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/api/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })"]
      interval: 30s
      timeout: 3s
      start_period: 5s
      retries: 3

  # NGINX Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: adherence-nginx
    ports:
      - '80:80'
      # For staging/production, you can use different ports:
      # - '8080:80'  # Staging
      # - '443:443'  # Production HTTPS (requires SSL certificates)
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - frontend
      - backend
    networks:
      - adherence-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis (for BullMQ queue - optional, can use external Redis)
  # If using external Redis (shared with people-ops), remove this service
  # and update REDIS_HOST in .env to point to external Redis
  redis:
    image: redis:7-alpine
    container_name: adherence-redis
    ports:
      - '6379:6379'
    command: redis-server --requirepass ${REDIS_PASSWORD:-}
    volumes:
      - redis-data:/data
    networks:
      - adherence-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

# Custom network for service communication
networks:
  adherence-network:
    driver: bridge

# Volumes
volumes:
  redis-data:
    driver: local

