<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">

  <?define ProductName = "Adherence Monitoring Agent" ?>
  <?define ProductVersion = "1.0.15" ?>
  <?define ProductCode = "*" ?>
  <?define UpgradeCode = "A1B2C3D4-E5F6-4A5B-8C9D-0E1F2A3B4C5D" ?>
  <?define Manufacturer = "Octopus WFM" ?>
  <?define ServiceName = "AdherenceAgentService" ?>
  <?define ServiceDisplayName = "Adherence Monitoring Agent" ?>
  <?define ServiceDescription = "Monitors workstation activity and uploads adherence data." ?>

  <Product Id="$(var.ProductCode)"
           Name="$(var.ProductName)"
           Language="1033"
           Version="$(var.ProductVersion)"
           Manufacturer="$(var.Manufacturer)"
           UpgradeCode="$(var.UpgradeCode)">

    <Package InstallerVersion="200"
             Compressed="yes"
             InstallScope="perMachine"
             Description="$(var.ProductName) Installer"
             Keywords="Adherence,Monitoring,Agent"
             Manufacturer="$(var.Manufacturer)" />

    <!-- Ensure correct admin detection under UAC (helps avoid confusing admin-required failures) -->
    <Property Id="MSIUSEREALADMINDETECTION" Value="1" />

    <!-- MajorUpgrade -->
    <!-- Schedule="afterInstallExecute" is the safest approach:
         - New files are installed first (while old product is still present)
         - Then old product is removed
         - This avoids "RemoveExistingProducts sequenced incorrectly" (error 2613)
         - File locks are avoided because new files go to temp locations first -->
    <MajorUpgrade 
        DowngradeErrorMessage="A newer version of [ProductName] is already installed."
        Schedule="afterInstallExecute"
        AllowSameVersionUpgrades="yes" />
    <MediaTemplate EmbedCab="yes" />

    <!-- Installation directory structure -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder">
        <Directory Id="INSTALLFOLDER" Name="AdherenceAgent">
          <Directory Id="ServiceFolder" Name="Service" />
          <Directory Id="TrayFolder" Name="Tray" />
        </Directory>
      </Directory>

      <Directory Id="CommonAppDataFolder">
        <Directory Id="ProgramDataFolder" Name="AdherenceAgent">
          <Directory Id="LogsFolder" Name="logs" />
        </Directory>
      </Directory>

      <!-- Per-machine Start Menu hierarchy (Startup is under ProgramData\...\Start Menu\Programs\Startup) -->
      <Directory Id="CommonProgramMenuFolder">
        <Directory Id="VendorProgramMenuFolder" Name="Octopus WFM">
          <Directory Id="AppProgramMenuFolder" Name="Adherence Monitoring Agent" />
        </Directory>
        <Directory Id="CommonStartupFolder" Name="Startup" />
      </Directory>
    </Directory>

    <!-- Feature -->
    <Feature Id="MainFeature" Title="$(var.ProductName)" Level="1">
      <ComponentGroupRef Id="ServiceComponents" />
      <ComponentGroupRef Id="TrayComponents" />
      <ComponentGroupRef Id="TrayStartupComponents" />
      <ComponentGroupRef Id="StartMenuComponents" />
      <ComponentGroupRef Id="ConfigComponents" />
      <ComponentGroupRef Id="DataFolderComponents" />
      <ComponentGroupRef Id="LogsFolderComponents" />
      <ComponentGroupRef Id="RootFolderCleanupComponents" />
    </Feature>

    <!-- Lock down service control so non-admin users can't stop/start it -->
    <!-- Uses WixQuietExec (built-in WiX CA) to run sc.exe sdset -->
    <CustomAction Id="SetServiceAcl"
                  BinaryKey="WixCA"
                  DllEntry="WixQuietExec"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />
    <CustomAction Id="SetServiceAcl_SetProperty"
                  Property="SetServiceAcl"
                  Value="&quot;[SystemFolder]sc.exe&quot; sdset $(var.ServiceName) &quot;D:(A;;CCLCSWRPWPDTLOCRRC;;;SY)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;CCLCSWLOCRRC;;;AU)&quot;" />

    <!-- Configure service recovery: restart on failure or termination -->
    <!-- Actions: restart after 60s, restart after 60s, restart after 60s (3 attempts) -->
    <!-- Reset counter after 24 hours (86400 seconds) -->
    <CustomAction Id="SetServiceRecovery"
                  BinaryKey="WixCA"
                  DllEntry="WixQuietExec"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />
    <CustomAction Id="SetServiceRecovery_SetProperty"
                  Property="SetServiceRecovery"
                  Value="&quot;[SystemFolder]sc.exe&quot; failure $(var.ServiceName) reset= 86400 actions= restart/60000/restart/60000/restart/60000" />
    <CustomAction Id="SetServiceRecoveryFlag"
                  BinaryKey="WixCA"
                  DllEntry="WixQuietExec"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />
    <CustomAction Id="SetServiceRecoveryFlag_SetProperty"
                  Property="SetServiceRecoveryFlag"
                  Value="&quot;[SystemFolder]sc.exe&quot; failureflag $(var.ServiceName) 1" />

    <!-- Ensure service/tray are not running during upgrade/uninstall (prevents file locks / rollback) -->
    <!-- Disable recovery first so the service won't auto-restart while MSI is uninstalling the old version -->
    <CustomAction Id="DisableServiceRecovery"
                  BinaryKey="WixCA"
                  DllEntry="WixQuietExec"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />
    <CustomAction Id="DisableServiceRecovery_SetProperty"
                  Property="DisableServiceRecovery"
                  Value="&quot;[SystemFolder]sc.exe&quot; failure $(var.ServiceName) reset= 0 actions= &quot;&quot;/&quot;&quot;/&quot;&quot;" />

    <CustomAction Id="StopService"
                  BinaryKey="WixCA"
                  DllEntry="WixQuietExec"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />
    <CustomAction Id="StopService_SetProperty"
                  Property="StopService"
                  Value="&quot;[SystemFolder]sc.exe&quot; stop $(var.ServiceName)" />

    <CustomAction Id="KillService"
                  BinaryKey="WixCA"
                  DllEntry="WixQuietExec"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />
    <CustomAction Id="KillService_SetProperty"
                  Property="KillService"
                  Value="&quot;[SystemFolder]taskkill.exe&quot; /F /T /IM AdherenceAgent.Service.exe" />

    <CustomAction Id="KillTray"
                  BinaryKey="WixCA"
                  DllEntry="WixQuietExec"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />
    <CustomAction Id="KillTray_SetProperty"
                  Property="KillTray"
                  Value="&quot;[SystemFolder]taskkill.exe&quot; /F /T /IM AdherenceAgent.Tray.exe" />

    <!-- Start service after install/upgrade (non-fatal). We avoid MSI StartServices failures causing rollback. -->
    <CustomAction Id="StartService"
                  BinaryKey="WixCA"
                  DllEntry="WixQuietExec"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />
    <CustomAction Id="StartService_SetProperty"
                  Property="StartService"
                  Value="&quot;[SystemFolder]sc.exe&quot; start $(var.ServiceName)" />


    <!-- Launch tray app after installation (for current user session) -->
    <!-- Note: ExecuteSequence runs elevated and cannot reliably launch GUI in user session.
         We launch from the UI sequence instead (see InstallUISequence below). -->
    <Property Id="WixShellExecTarget" Value="[#TrayExeFile]" />
    <CustomAction Id="LaunchTrayApp"
                  BinaryKey="WixCA"
                  DllEntry="WixShellExec"
                  Execute="immediate"
                  Impersonate="yes"
                  Return="ignore" />

    <InstallExecuteSequence>
      <!-- With Schedule="afterInstallExecute", RemoveExistingProducts runs AFTER InstallFinalize.
           We still need to stop/kill early during UPGRADES so that:
           1. Files can be overwritten without locks
           2. New service/tray start fresh with new code
           Also run during explicit uninstall (REMOVE="ALL"). -->
      
      <!-- Stop/kill during upgrade OR uninstall -->
      <Custom Action="DisableServiceRecovery_SetProperty" After="InstallInitialize"><![CDATA[WIX_UPGRADE_DETECTED OR (REMOVE="ALL")]]></Custom>
      <Custom Action="DisableServiceRecovery" After="DisableServiceRecovery_SetProperty"><![CDATA[WIX_UPGRADE_DETECTED OR (REMOVE="ALL")]]></Custom>

      <Custom Action="StopService_SetProperty" After="DisableServiceRecovery"><![CDATA[WIX_UPGRADE_DETECTED OR (REMOVE="ALL")]]></Custom>
      <Custom Action="StopService" After="StopService_SetProperty"><![CDATA[WIX_UPGRADE_DETECTED OR (REMOVE="ALL")]]></Custom>

      <Custom Action="KillService_SetProperty" After="StopService"><![CDATA[WIX_UPGRADE_DETECTED OR (REMOVE="ALL")]]></Custom>
      <Custom Action="KillService" After="KillService_SetProperty"><![CDATA[WIX_UPGRADE_DETECTED OR (REMOVE="ALL")]]></Custom>

      <Custom Action="KillTray_SetProperty" After="KillService"><![CDATA[WIX_UPGRADE_DETECTED OR (REMOVE="ALL")]]></Custom>
      <Custom Action="KillTray" After="KillTray_SetProperty"><![CDATA[WIX_UPGRADE_DETECTED OR (REMOVE="ALL")]]></Custom>

      <!-- Set service ACL and recovery on install/upgrade -->
      <!-- Service exists after InstallServices, and Return="ignore" handles any errors gracefully -->
      <Custom Action="SetServiceAcl_SetProperty" After="InstallServices"><![CDATA[NOT Installed OR UPGRADINGPRODUCTCODE]]></Custom>
      <Custom Action="SetServiceAcl" After="SetServiceAcl_SetProperty"><![CDATA[NOT Installed OR UPGRADINGPRODUCTCODE]]></Custom>
      <Custom Action="SetServiceRecovery_SetProperty" After="InstallServices"><![CDATA[NOT Installed OR UPGRADINGPRODUCTCODE]]></Custom>
      <Custom Action="SetServiceRecovery" After="SetServiceRecovery_SetProperty"><![CDATA[NOT Installed OR UPGRADINGPRODUCTCODE]]></Custom>
      <Custom Action="SetServiceRecoveryFlag_SetProperty" After="InstallServices"><![CDATA[NOT Installed OR UPGRADINGPRODUCTCODE]]></Custom>
      <Custom Action="SetServiceRecoveryFlag" After="SetServiceRecoveryFlag_SetProperty"><![CDATA[NOT Installed OR UPGRADINGPRODUCTCODE]]></Custom>

      <!-- Non-fatal service start near the end of execute sequence.
           ICE77: in-script (deferred) CAs must be between InstallInitialize and InstallFinalize. -->
      <Custom Action="StartService_SetProperty" After="InstallServices"><![CDATA[NOT Installed OR WIX_UPGRADE_DETECTED]]></Custom>
      <Custom Action="StartService" After="StartService_SetProperty"><![CDATA[NOT Installed OR WIX_UPGRADE_DETECTED]]></Custom>
    </InstallExecuteSequence>

    <!-- Launch tray after install only when UI is present -->
    <InstallUISequence>
      <Custom Action="LaunchTrayApp" After="ExecuteAction"><![CDATA[NOT Installed]]></Custom>
    </InstallUISequence>

    <!-- UI -->
    <UIRef Id="WixUI_Minimal" />
    <!-- Use our license text instead of WiX placeholder -->
    <WixVariable Id="WixUILicenseRtf" Value="$(var.LicenseRtfPath)" />

  </Product>

  <!-- Service + files -->
  <Fragment>
    <ComponentGroup Id="ServiceComponents" Directory="ServiceFolder">
      <Component Id="ServiceExe" Guid="B1C2D3E4-F5A6-4B7C-8D9E-0F1A2B3C4D5E">
        <File Id="ServiceExeFile"
              Source="$(var.ServiceBinPath)\AdherenceAgent.Service.exe"
              KeyPath="yes" />

        <ServiceInstall Id="ServiceInstall"
                       Type="ownProcess"
                       Name="$(var.ServiceName)"
                       DisplayName="$(var.ServiceDisplayName)"
                       Description="$(var.ServiceDescription)"
                       Start="auto"
                       Account="LocalSystem"
                       ErrorControl="normal"
                       Interactive="no" />

        <ServiceControl Id="ServiceControl"
                        Name="$(var.ServiceName)"
                        Remove="uninstall" />
      </Component>

      <!-- Cleanup: remove any leftover files in ServiceFolder on uninstall.
           Prevents Error 2911 when extra files exist that were not installed by MSI. -->
      <Component Id="ServiceFolderCleanup" Guid="1E2D3C4B-5A69-4C8D-9E0F-1029384756AA">
        <CreateFolder />
        <RemoveFile Id="RemoveServiceFolderFiles" Name="*.*" On="uninstall" />
        <RemoveFolder Id="RemoveServiceFolder" On="uninstall" />
        <RegistryValue Root="HKLM"
                       Key="Software\OctopusWFM\AdherenceAgent"
                       Name="ServiceFolderCleanup"
                       Type="integer"
                       Value="1"
                       KeyPath="yes" />
      </Component>
    </ComponentGroup>
  </Fragment>

  <!-- Tray + files -->
  <Fragment>
    <ComponentGroup Id="TrayComponents" Directory="TrayFolder">
      <Component Id="TrayExe" Guid="C2D3E4F5-A6B7-4C8D-9E0F-1A2B3C4D5E6F">
        <File Id="TrayExeFile"
              Source="$(var.TrayBinPath)\AdherenceAgent.Tray.exe"
              KeyPath="yes" />
      </Component>

      <Component Id="TrayConfig" Guid="9F2C5B32-0F8E-4D8A-9E6B-7C9EDB2C8C6A">
        <File Id="TrayConfigFile"
              Source="$(var.TrayBinPath)\appsettings.json"
              KeyPath="yes" />
      </Component>

      <!-- Cleanup: remove any leftover files in TrayFolder on uninstall.
           Prevents Error 2911 when extra files exist that were not installed by MSI. -->
      <Component Id="TrayFolderCleanup" Guid="6D5C4B3A-2918-4706-A9D7-8E8A9B0C1D2E">
        <CreateFolder />
        <RemoveFile Id="RemoveTrayFolderFiles" Name="*.*" On="uninstall" />
        <RemoveFolder Id="RemoveTrayFolder" On="uninstall" />
        <RegistryValue Root="HKLM"
                       Key="Software\OctopusWFM\AdherenceAgent"
                       Name="TrayFolderCleanup"
                       Type="integer"
                       Value="1"
                       KeyPath="yes" />
      </Component>
    </ComponentGroup>
  </Fragment>

  <!-- Tray startup shortcut (all users) -->
  <Fragment>
    <DirectoryRef Id="CommonStartupFolder">
      <Component Id="TrayStartupShortcutComponent" Guid="D3E4F5A6-B7C8-4D9E-0F1A-2B3C4D5E6F7A">
        <CreateFolder />
        <Shortcut Id="TrayStartupShortcut"
                  Name="Adherence Agent"
                  Description="Adherence Monitoring Agent Tray Application"
                  Target="[INSTALLFOLDER]Tray\AdherenceAgent.Tray.exe"
                  WorkingDirectory="TrayFolder" />
        <!-- Ensure shortcut is removed on uninstall (ICE64) -->
        <RemoveFile Id="RemoveTrayStartupShortcut" Name="Adherence Agent.lnk" On="uninstall" />
        <RegistryValue Root="HKLM"
                       Key="Software\OctopusWFM\AdherenceAgent"
                       Name="TrayAutoStart"
                       Type="integer"
                       Value="1"
                       KeyPath="yes" />
      </Component>
    </DirectoryRef>
  </Fragment>

  <!-- Start Menu shortcut (all users) -->
  <Fragment>
    <DirectoryRef Id="AppProgramMenuFolder">
      <Component Id="StartMenuShortcutComponent" Guid="2A4F6D11-8D5E-4F56-9E61-9B9082E6F2C1">
        <CreateFolder />
        <Shortcut Id="StartMenuTrayShortcut"
                  Name="Adherence Agent"
                  Description="Adherence Monitoring Agent Tray Application"
                  Target="[INSTALLFOLDER]Tray\AdherenceAgent.Tray.exe"
                  WorkingDirectory="TrayFolder" />
        <RemoveFolder Id="RemoveAppProgramMenuFolder" On="uninstall" />
        <RemoveFolder Id="RemoveVendorProgramMenuFolder" Directory="VendorProgramMenuFolder" On="uninstall" />
        <RegistryValue Root="HKLM"
                       Key="Software\OctopusWFM\AdherenceAgent"
                       Name="StartMenuShortcut"
                       Type="integer"
                       Value="1"
                       KeyPath="yes" />
      </Component>
    </DirectoryRef>

    <ComponentGroup Id="StartMenuComponents">
      <ComponentRef Id="StartMenuShortcutComponent" />
    </ComponentGroup>
  </Fragment>

  <!-- Root folder cleanup (remove INSTALLFOLDER/ProgramDataFolder if empty on uninstall) -->
  <Fragment>
    <DirectoryRef Id="INSTALLFOLDER">
      <Component Id="InstallRootCleanup" Guid="8B3C2A51-7F66-4C4A-9C45-2F0F9A1A9E33">
        <CreateFolder />
        <RemoveFolder Id="RemoveInstallRootFolder" On="uninstall" />
        <RegistryValue Root="HKLM"
                       Key="Software\OctopusWFM\AdherenceAgent"
                       Name="InstallRootCleanup"
                       Type="integer"
                       Value="1"
                       KeyPath="yes" />
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="ProgramDataFolder">
      <Component Id="ProgramDataRootCleanup" Guid="B0C48B1B-2D4E-4F0C-9AA4-0F996B5C7A12">
        <CreateFolder />
        <RemoveFolder Id="RemoveProgramDataRootFolder" On="uninstall" />
        <RegistryValue Root="HKLM"
                       Key="Software\OctopusWFM\AdherenceAgent"
                       Name="ProgramDataRootCleanup"
                       Type="integer"
                       Value="1"
                       KeyPath="yes" />
      </Component>
    </DirectoryRef>

    <ComponentGroup Id="RootFolderCleanupComponents">
      <ComponentRef Id="InstallRootCleanup" />
      <ComponentRef Id="ProgramDataRootCleanup" />
    </ComponentGroup>
  </Fragment>

  <Fragment>
    <ComponentGroup Id="TrayStartupComponents">
      <ComponentRef Id="TrayStartupShortcutComponent" />
    </ComponentGroup>
  </Fragment>


  <!-- Service config -->
  <Fragment>
    <ComponentGroup Id="ConfigComponents" Directory="ServiceFolder">
      <Component Id="ServiceConfig" Guid="E4F5A6B7-C8D9-4E0F-1A2B-3C4D5E6F7A8B">
        <File Id="ServiceConfigFile"
              Source="$(var.ServiceBinPath)\appsettings.json"
              KeyPath="yes" />
      </Component>
    </ComponentGroup>
  </Fragment>

  <!-- ProgramData folders -->
  <Fragment>
    <ComponentGroup Id="DataFolderComponents" Directory="ProgramDataFolder">
      <Component Id="DataFolder" Guid="F5A6B7C8-D9E0-4F1A-2B3C-4D5E6F7A8B9C">
        <CreateFolder>
          <!-- Allow interactive users (tray) to write the shared SQLite DB in ProgramData -->
          <util:PermissionEx User="Users" GenericRead="yes" GenericWrite="yes" GenericExecute="yes" Delete="yes" />
        </CreateFolder>
        <!-- Keep data on uninstall: do not remove ProgramDataFolder -->
        <RegistryValue Root="HKLM"
                       Key="Software\OctopusWFM\AdherenceAgent"
                       Name="DataFolderCreated"
                       Type="integer"
                       Value="1"
                       KeyPath="yes" />
      </Component>
    </ComponentGroup>
  </Fragment>

  <Fragment>
    <ComponentGroup Id="LogsFolderComponents" Directory="LogsFolder">
      <Component Id="LogsFolderComponent" Guid="A6B7C8D9-E0F1-4A2B-3C4D-5E6F7A8B9C0D">
        <CreateFolder>
          <!-- Allow tray/service to write logs for non-admin users -->
          <util:PermissionEx User="Users" GenericRead="yes" GenericWrite="yes" GenericExecute="yes" Delete="yes" />
        </CreateFolder>
        <RegistryValue Root="HKLM"
                       Key="Software\OctopusWFM\AdherenceAgent"
                       Name="LogsFolderCreated"
                       Type="integer"
                       Value="1"
                       KeyPath="yes" />
      </Component>
    </ComponentGroup>
  </Fragment>

</Wix>
